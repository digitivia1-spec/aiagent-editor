<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Command Center</title>
    <style>
        :root {
            /* Default Theme (Website/Generic) */
            --theme-color: #4363E8; 
            --glass-bg: rgba(93, 93, 91, 0.25);
            --glass-border: rgba(255, 255, 255, 0.1);
            --bg-dark: #0f1014;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --success: #2ecc71;
            --error: #e74c3c;
            --sidebar-width: 300px;
        }

        /* --- Theme Classes --- */
        body.theme-whatsapp { --theme-color: #25D366; --bg-dark: #0b141a; }
        body.theme-messenger { --theme-color: #0084FF; --bg-dark: #101010; }
        body.theme-instagram { --theme-color: #E1306C; --bg-dark: #000000; }
        body.theme-website { --theme-color: #00E5FF; --bg-dark: #0f1014; }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            /* Dynamic background gradient based on theme */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, var(--theme-color) 10%, transparent 40%);
            background-size: cover;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
        }

        /* --- Glassmorphism Utils --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* --- Navigation --- */
        nav {
            position: fixed; top: 0; width: 100%; z-index: 100;
            padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; color: var(--theme-color); transition: color 0.5s; }
        .nav-links { display: flex; gap: 2rem; }
        .nav-item {
            cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px;
            transition: all 0.3s ease; color: var(--text-muted); font-size: 0.9rem;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { background: var(--theme-color); color: white; box-shadow: 0 0 15px var(--theme-color); }
        .hamburger { display: none; cursor: pointer; font-size: 1.5rem; }

        /* --- Main Content --- */
        main { flex: 1; padding: 6rem 1rem 2rem 1rem; max-width: 1200px; width: 100%; margin: 0 auto; }
        
        .tab-content { display: none; animation: fadeIn 0.4s ease; width: 100%; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Standard Config Cards --- */
        .config-wrapper { max-width: 800px; margin: 0 auto; }
        .card { border-radius: 20px; padding: 2rem; }
        h2 { margin-bottom: 1.5rem; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .icon-circle { width: 12px; height: 12px; border-radius: 50%; background: var(--theme-color); display: inline-block; transition: background 0.5s; }

        /* --- Accordion --- */
        .section-wrapper { margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 1.5rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.5rem 0; font-weight: 600; }
        .section-header:hover { color: var(--theme-color); }
        .section-header::after { content: 'â–¼'; font-size: 0.8rem; transition: transform 0.3s; }
        .section-header.active::after { transform: rotate(180deg); }
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.3s ease; opacity: 0; }
        .section-content.open { max-height: 1000px; opacity: 1; margin-top: 1rem; }

        /* --- Inputs --- */
        label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem; }
        textarea, input[type="text"], select { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 12px; padding: 1rem; color: white; outline: none; transition: border 0.3s; }
        textarea { height: 150px; resize: vertical; }
        textarea:focus, input:focus, select:focus { border-color: var(--theme-color); }
        select option { background: #1a1b20; }

        /* --- Live Inbox UI --- */
        .inbox-container {
            display: flex;
            height: 75vh;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .inbox-sidebar {
            width: var(--sidebar-width);
            background: rgba(0,0,0,0.2);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
        }

        .platform-selector {
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .platform-btn {
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .platform-btn:hover, .platform-btn.active { background: var(--theme-color); transform: scale(1.1); }

        .contact-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .contact-item {
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 5px;
            display: flex; align-items: center; gap: 10px;
        }
        .contact-item:hover { background: rgba(255,255,255,0.05); }
        .contact-item.active { background: rgba(255,255,255,0.1); border-left: 3px solid var(--theme-color); }
        .contact-avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-preview { font-size: 0.8rem; color: var(--text-muted); }

        .inbox-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.1);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            font-weight: bold;
            display: flex; align-items: center; gap: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .load-more-btn {
            align-self: center;
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        .load-more-btn:hover { color: white; border-color: var(--theme-color); }

        .chat-msg {
            max-width: 70%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .chat-msg.user { align-self: flex-start; background: #2d2d2d; border-bottom-left-radius: 2px; }
        .chat-msg.ai { align-self: flex-end; background: var(--theme-color); color: white; border-bottom-right-radius: 2px; }

        /* --- Action Buttons --- */
        .save-btn {
            background: var(--theme-color); color: white; border: none; padding: 0.8rem 2rem;
            border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .save-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .pill-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 0.4rem 1rem; border-radius: 50px; cursor: pointer; margin-right: 5px; margin-bottom: 5px; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .nav-links { display: none; position: absolute; top: 60px; left: 0; width: 100%; background: #1a1b20; flex-direction: column; }
            .nav-links.open { display: flex; }
            .inbox-container { flex-direction: column; height: auto; }
            .inbox-sidebar { width: 100%; height: 300px; }
            .inbox-chat { height: 500px; }
            .hamburger { display: block; }
        }
    </style>
</head>
<body class="theme-website">

    <div id="loader-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:flex; justify-content:center; align-items:center; flex-direction:column;">
        <div style="width:40px; height:40px; border:3px solid #333; border-top-color:white; border-radius:50%; animation:spin 1s infinite linear;"></div>
        <div style="margin-top:10px; color:#aaa;">Loading...</div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <nav class="glass">
        <div class="logo">DIGITIVIA</div>
        <div class="hamburger" onclick="toggleMenu()">â˜°</div>
        <div class="nav-links" id="navLinks">
            <div class="nav-item active" onclick="switchMainTab('config')">Configuration</div>
            <div class="nav-item" onclick="switchMainTab('inbox')">Live Inbox ðŸ”´</div>
        </div>
    </nav>

    <main>
        
        <div id="tab-config" class="tab-content active">
            <div style="display:flex; gap:10px; margin-bottom:20px; overflow-x:auto; padding-bottom:10px;">
                <button class="pill-btn" onclick="switchConfigAgent('website')">Website</button>
                <button class="pill-btn" onclick="switchConfigAgent('whatsapp')">WhatsApp</button>
                <button class="pill-btn" onclick="switchConfigAgent('messenger')">Messenger</button>
                <button class="pill-btn" onclick="switchConfigAgent('instagram')">Instagram</button>
            </div>

            <div id="config-dynamic-area" class="config-wrapper"></div>
        </div>


        <div id="tab-inbox" class="tab-content">
            <div class="card glass inbox-container">
                
                <div class="inbox-sidebar">
                    <div class="platform-selector">
                        <button class="platform-btn" title="WhatsApp" onclick="loadInbox('whatsapp')">W</button>
                        <button class="platform-btn" title="Messenger" onclick="loadInbox('messenger')">M</button>
                        <button class="platform-btn" title="Instagram" onclick="loadInbox('instagram')">I</button>
                    </div>
                    <div style="padding:10px; font-size:0.8rem; color:#aaa; text-align:center;">Select platform to load chats</div>
                    <div id="contact-list" class="contact-list">
                        </div>
                </div>

                <div class="inbox-chat">
                    <div class="chat-header">
                        <span id="chat-header-name">Select a conversation</span>
                    </div>
                    <div id="inbox-messages" class="chat-messages">
                        </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        const CONFIG_WEBHOOK = "https://n8n.srv1174105.hstgr.cloud/webhook/promptAgent";
        const CHAT_WEBHOOK   = "https://n8n.srv1174105.hstgr.cloud/webhook/chatHandler";

        // Agents Data
        const AGENTS = [
            { id: 'website', name: 'Website Agent', color: '#00E5FF', theme: 'theme-website' },
            { id: 'whatsapp', name: 'WhatsApp Agent', color: '#25D366', theme: 'theme-whatsapp' },
            { id: 'messenger', name: 'Messenger Agent', color: '#0084FF', theme: 'theme-messenger' },
            { id: 'instagram', name: 'Instagram Agent', color: '#E1306C', theme: 'theme-instagram' }
        ];

        // --- GLOBAL STATE ---
        let currentConfigAgent = 'website';
        let currentInboxPlatform = 'whatsapp';
        let currentChatUser = null;
        let chatPage = 1;

        // --- INIT ---
        window.onload = function() {
            buildConfigInterface();
            fetchConfigData();
            document.getElementById('loader-overlay').style.display = 'none';
        };

        // ==========================================
        //       PART 1: NAVIGATION & THEMES
        // ==========================================

        function switchMainTab(tabName) {
            document.getElementById('tab-config').classList.remove('active');
            document.getElementById('tab-inbox').classList.remove('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.add('active');
            // Highlight nav
            const navIndex = tabName === 'config' ? 0 : 1;
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            // Reset theme if going back to config
            if(tabName === 'config') setTheme(currentConfigAgent);
            else setTheme(currentInboxPlatform);
        }

        function switchConfigAgent(agentId) {
            currentConfigAgent = agentId;
            setTheme(agentId);
            
            // Show only selected agent card
            document.querySelectorAll('.agent-config-card').forEach(el => el.style.display = 'none');
            document.getElementById(`card-${agentId}`).style.display = 'block';
        }

        function setTheme(agentId) {
            const agent = AGENTS.find(a => a.id === agentId);
            if(agent) {
                document.body.className = agent.theme;
            }
        }

        // ==========================================
        //       PART 2: LIVE INBOX LOGIC
        // ==========================================

        async function loadInbox(platform) {
            currentInboxPlatform = platform;
            setTheme(platform);
            
            // UI Update
            document.querySelectorAll('.platform-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active'); // active clicked button

            const list = document.getElementById('contact-list');
            list.innerHTML = '<div style="padding:20px; text-align:center;">Loading...</div>';

            try {
                // Fetch Unique Users (Requires n8n action=get_contacts)
                const res = await fetch(`${CHAT_WEBHOOK}?action=get_contacts&platform=${platform}`);
                const data = await res.json();
                
                list.innerHTML = '';
                
                // Assuming data is array of { user_id: '123', last_message: '...' }
                const users = Array.isArray(data) ? data : (data.users || []);

                if(users.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center;">No active chats found.</div>';
                    return;
                }

                users.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'contact-item';
                    div.onclick = () => loadConversation(u.user_id, platform);
                    div.innerHTML = `
                        <div class="contact-avatar">${u.user_id.substring(0,2).toUpperCase()}</div>
                        <div class="contact-info">
                            <div class="contact-name">${u.user_id}</div>
                            <div class="contact-preview">Click to view chat</div>
                        </div>
                    `;
                    list.appendChild(div);
                });

            } catch(e) {
                console.error(e);
                list.innerHTML = '<div style="color:red; padding:20px;">Error loading contacts</div>';
            }
        }

        async function loadConversation(userId, platform, page = 1) {
            currentChatUser = userId;
            chatPage = page;
            const container = document.getElementById('inbox-messages');
            
            if(page === 1) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">Loading messages...</div>';
                document.getElementById('chat-header-name').innerText = `Chat with ${userId}`;
                
                // Update active state in sidebar
                document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
                // (Optional: Find clicked element and add active)
            }

            try {
                // Fetch Messages (Requires n8n action=get_messages)
                const offset = (page - 1) * 20; 
                const res = await fetch(`${CHAT_WEBHOOK}?action=get_messages&platform=${platform}&user_id=${userId}&limit=20&offset=${offset}`);
                const data = await res.json();
                
                const messages = Array.isArray(data) ? data : (data.messages || []);

                if(page === 1) container.innerHTML = '';

                // Add "Load More" button if it's page 1 and we have data
                if(page === 1 && messages.length >= 20) {
                    const btn = document.createElement('button');
                    btn.className = 'load-more-btn';
                    btn.innerText = 'Load Previous Messages';
                    btn.onclick = () => loadConversation(userId, platform, chatPage + 1);
                    container.prepend(btn);
                }

                // Render Messages (Prepend if pagination, Append if new)
                // Note: Messages usually come oldest -> newest. 
                // For pagination (history), we might need to handle order carefully.
                
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    // 'sender' from DB should be 'user' or 'ai'
                    div.className = `chat-msg ${msg.sender === 'user' ? 'user' : 'ai'}`;
                    div.innerText = msg.message;
                    
                    if(page === 1) container.appendChild(div); // Append normally
                    else {
                        // Insert after load button
                         container.insertBefore(div, container.children[1]); 
                    }
                });

                if(page === 1) container.scrollTop = container.scrollHeight;

            } catch(e) {
                console.error(e);
            }
        }

        // ==========================================
        //       PART 3: CONFIGURATION BUILDER
        // ==========================================
        // (This rebuilds your original dashboard UI dynamically)

        function buildConfigInterface() {
            const container = document.getElementById('config-dynamic-area');
            container.innerHTML = '';

            AGENTS.forEach((agent, index) => {
                const displayStyle = index === 0 ? 'block' : 'none'; // Show first agent by default
                
                const html = `
                <div id="card-${agent.id}" class="agent-config-card" style="display:${displayStyle}">
                    <div class="card glass">
                        <h2><span class="icon-circle" style="background: ${agent.color};"></span> ${agent.name} Configuration</h2>
                        
                        <div class="section-wrapper">
                            <div class="section-header active" onclick="toggleSection('${agent.id}-prompt')">System Prompt</div>
                            <div id="${agent.id}-prompt" class="section-content open">
                                <textarea id="prompt-${agent.id}" placeholder="Enter system prompt..."></textarea>
                            </div>
                        </div>

                        <div class="section-wrapper">
                            <div class="section-header" onclick="toggleSection('${agent.id}-tone')">Agent Tone</div>
                            <div id="${agent.id}-tone" class="section-content">
                                <select id="tone-${agent.id}">
                                    <option value="" disabled selected>Select Tone</option>
                                    <option value="Professional">Professional</option>
                                    <option value="Friendly">Friendly</option>
                                    <option value="Sales">Sales</option>
                                </select>
                            </div>
                        </div>

                        <div class="section-wrapper">
                            <div class="section-header" onclick="toggleSection('${agent.id}-chat')">Test Chat</div>
                            <div id="${agent.id}-chat" class="section-content">
                                <div class="chat-container">
                                    <div id="history-${agent.id}" class="chat-history"></div>
                                    <div class="chat-input-area">
                                        <input id="input-${agent.id}" placeholder="Type...">
                                        <button class="send-chat-btn" onclick="sendTestChat('${agent.id}')">âž¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="action-container">
                            <button class="save-btn" onclick="saveConfig('${agent.id}')">Save Settings</button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        // Helper Functions for Config
        function toggleSection(id) {
            document.getElementById(id).classList.toggle('open');
        }

        async function fetchConfigData() {
            // Re-using your existing fetch logic
            try {
                const res = await fetch(CONFIG_WEBHOOK);
                const data = await res.json();
                AGENTS.forEach(a => {
                    if(data[`system_prompt_${a.id}`]) document.getElementById(`prompt-${a.id}`).value = data[`system_prompt_${a.id}`];
                    if(data[`agent_tone_${a.id}`]) document.getElementById(`tone-${a.id}`).value = data[`agent_tone_${a.id}`];
                });
            } catch(e) { console.log("Config load error", e); }
        }

        async function saveConfig(agentId) {
            const prompt = document.getElementById(`prompt-${agentId}`).value;
            const tone = document.getElementById(`tone-${agentId}`).value;
            
            // Simplified save payload for demo
            const payload = { agent_source: agentId, system_prompt: prompt };
            payload[`agent_tone_${agentId}`] = tone;

            await fetch(CONFIG_WEBHOOK, { method: 'POST', body: JSON.stringify(payload) });
            alert('Saved!');
        }
        
        // Simple Test Chat Logic (Mini Version)
        async function sendTestChat(agentId) {
            const input = document.getElementById(`input-${agentId}`);
            const text = input.value; 
            if(!text) return;
            
            const hist = document.getElementById(`history-${agentId}`);
            hist.innerHTML += `<div class="chat-msg user" style="align-self:flex-end; background:${AGENTS.find(a=>a.id===agentId).color}">${text}</div>`;
            input.value = '';

            // Send to webhook
            const res = await fetch(CHAT_WEBHOOK, { method: 'POST', body: JSON.stringify({ agent_source: agentId, message: text, sender:'user' }) });
            const data = await res.json();
            
            hist.innerHTML += `<div class="chat-msg ai">${data.reply || "..."}</div>`;
            hist.scrollTop = hist.scrollHeight;
        }

        function toggleMenu() { document.getElementById('navLinks').classList.toggle('open'); }

    </script>
</body>
</html>
